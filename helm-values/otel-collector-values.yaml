---
# Specifies the OTel Collector container image.
image:
  # Uses the 'contrib' image to include exporters like Loki and Prometheus Remote Write.
  repository: otel/opentelemetry-collector-contrib
  # Pins the image tag.
  tag: 0.103.1

# Sets the collector's deployment strategy to a standard Kubernetes Deployment.
mode: deployment

# Defines the OTel Collector's pipeline configuration.
config:
  receivers:
    # Configures the OTLP receiver to accept telemetry from applications.
    otlp:
      protocols:
        # Enables the gRPC protocol (used by your Python apps).
        grpc: {}
        # Enables the HTTP protocol (for flexibility).
        http: {}

  processors:
    # Batches telemetry data for more efficient network use.
    batch: {}
    # Limits the memory consumption of the collector.
    memory_limiter:
      check_interval: 1s
      limit_percentage: 75
      spike_limit_percentage: 15
    # The 'k8sattributes' processor is enabled here by the 'presets' below.

  exporters:
    # --- Metrics Exporter ---
    # Pushes OTel metrics to Prometheus using the Remote Write API.
    prometheusremotewrite:
      # Targets the Prometheus service endpoint in the 'monitoring' namespace.
      endpoint: "http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090/api/v1/write"
      # Disables TLS verification for internal cluster traffic.
      tls:
        insecure: true

    # --- Traces Exporter ---
    # Sends OTel traces via gRPC to the Tempo backend.
    otlp/tempo:
      # Targets the Tempo service endpoint in the 'tracing' namespace.
      endpoint: "tempo.tracing.svc.cluster.local:4317"
      tls:
        insecure: true

    # --- Logs Exporter ---
    # Converts OTel logs to the Loki format and pushes them.
    loki:
      # Targets the main Loki service endpoint in the 'logging' namespace.
      endpoint: "http://loki.logging.svc.cluster.local:3100/loki/api/v1/push"
      tls:
        insecure: true

    # --- Debug Exporter ---
    # Prints all processed telemetry data to the collector's console log.
    logging:
      loglevel: debug

  service:
    # Defines the routing pipelines.
    pipelines:
      # --- Metrics Pipeline ---
      metrics:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, batch]
        # Routes data to Prometheus and the console log.
        exporters: [prometheusremotewrite, logging]

      # --- Traces Pipeline ---
      traces:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, batch]
        # Routes data to Tempo and the console log.
        exporters: [otlp/tempo, logging]

      # --- Logs Pipeline ---
      logs:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, batch]
        # Routes data to Loki and the console log.
        exporters: [loki, logging]

# Enables the preset for enriching telemetry with Kubernetes metadata (pod name, namespace, etc.).
presets:
  kubernetesAttributes:
    enabled: true
